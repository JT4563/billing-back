# Billing Backend (Scalable, Express + MongoDB)

A mature, stable backend built for **~200,000 requests/day** continuously.  
Features: **owner-only sign-in via access code**, **per-invoice company fields** (provided by frontend), **truck quantity**, **PDF/CSV exports**, **dashboard with daily/monthly/annual metrics**, **pagination**, **indexes**, **rate limiting**, **compression**, and **Docker**.

## Quick Start
1. Copy `.env.example` to `.env` and set values.
2. Install deps:
   ```bash
   npm install
   ```
3. Seed the owner access code (reads `ACCESS_CODE_SEED` from `.env`):
   ```bash
   npm run seed
   ```
4. Run dev:
   ```bash
   npm run dev
   ```

Or with Docker:
```bash
docker compose up --build -d
```

---

## Design Notes (scale-ready)
- **Stateless API** (JWT auth) → easy horizontal scaling.
- **MongoDB indexes** on `invoiceNumber`, `createdAt`, `ownerId`.
- **Pagination** on listings (default 50, max 500).
- **Exports require date range** to prevent huge downloads.
- **Rate limiting** + **compression** + reasonable **JSON body limit**.
- **PDF and CSV** generated on-demand and streamed (temp files auto-cleaned after download).

---

## Auth
### `POST /api/auth/sign-in`
Body:
```json
{ "accessCode": "..." }
```
- Access code is stored **hashed** in DB (seeded by `ACCESS_CODE_SEED`).
- Returns `{ "token": "<JWT>" }`. Use header `Authorization: Bearer <token>`.

---

## Invoices (Billing)
Per-invoice company header comes **from frontend** and is saved **with the invoice**.

### Model
```json
{
  "invoiceNumber": 1001,                 // generated by backend (unique)
  "companyName": "ABC Traders",          // from frontend
  "companyPhone": "+91-9000000000",      // from frontend
  "companyAddress": "123 Market Road",   // from frontend
  "companyGst": "29ABCDE1234F2Z5",       // from frontend
  "ratePerTon": 12000,                   // from frontend
  "trucks": 5,                           // from frontend
  "total": 60000,                        // computed by server
  "notes": "optional",
  "createdAt": "..."
}
```

### Endpoints
- `POST /api/invoices` (auth) — create invoice
  ```json
  {
    "companyName": "ABC Traders",
    "companyPhone": "+91-9000000000",
    "companyAddress": "123 Market Road, City",
    "companyGst": "29ABCDE1234F2Z5",
    "ratePerTon": 12000,
    "trucks": 5,
    "notes": "optional"
  }
  ```
  Server computes `total = ratePerTon * trucks` and generates `invoiceNumber`.

- `GET /api/invoices` (auth) — list with pagination & filters  
  Query:
  - `?from=YYYY-MM-DD&to=YYYY-MM-DD` (optional date range)
  - `?page=1&limit=50` (defaults: page 1, limit 50; max limit 500)
  - Response: `{ data: [...], page, limit, total }`

- `GET /api/invoices/:id` (auth) — fetch single invoice

- `GET /api/invoices/:id/pdf` (auth) — download **PDF**

- `GET /api/invoices/export/csv?from=...&to=...` (auth) — download **CSV**
  - **Date range is required** to avoid massive exports.

---

## Dashboard
- `GET /api/dashboard/summary` (auth)  
  Optional: `?from=YYYY-MM-DD&to=YYYY-MM-DD`  
  Returns summary of invoices, revenue, trucks, avg rate, plus this month, previous month, and this year rollups.

- `GET /api/dashboard/daily?date=YYYY-MM-DD` (auth)  
  Returns that day's invoices + totals for a daily view.

---

## Health & Metrics
- `GET /health` → `{ ok: true }`

---

## Production Tips
- Run multiple instances (PM2 cluster or container replicas) behind a load balancer.
- Use MongoDB Atlas or a replica set; size indexes and enable backups.
- Set strong `JWT_SECRET` and rotate periodically.
- Prefer **date ranges** on heavy endpoints (CSV) to keep memory low.

